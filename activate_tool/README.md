# PikPak 自动激活脚本使用说明

## 功能简介

`activate.py` 是一个独立的自动激活脚本，用于：
- 查询上次激活时间为前一天12点后且激活次数小于3的账号
- 自动调用激活接口进行激活
- 支持重试机制和日志记录
- 每个账号激活后暂停10-30秒

## 配置文件

首先复制配置文件模板：
```bash
cp activate_config.json.example activate_config.json
```

然后编辑 `activate_config.json`：
```json
{
  "activation_key": "your_actual_activation_key",
  "api_base_url": "http://localhost:5000",
  "session_id": "auto_activator",
  "db_path": "accounts.db",
  "min_sleep_seconds": 10,
  "max_sleep_seconds": 30,
  "max_retries": 3,
  "retry_delay_seconds": 5,
  "max_activation_count": 3
}
```

### 配置说明

- `activation_key`: 激活密钥（必需）, 在 https://kiteyuan.info/ 获取
- `api_base_url`: API服务地址，默认本地5000端口
- `session_id`: 会话ID，用于数据库操作权限。管理员会话可激活所有账号，普通会话只能激活自己的账号
- `db_path`: 数据库文件路径
- `min_sleep_seconds`: 每个账号激活后的最小暂停时间
- `max_sleep_seconds`: 每个账号激活后的最大暂停时间
- `max_retries`: 激活失败时的最大重试次数
- `retry_delay_seconds`: 重试间隔时间
- `max_activation_count`: 最大激活次数限制，默认为3

## 使用方法

### 1. 使用配置文件

```bash
python activate.py
```

### 2. 使用命令行参数

```bash
python activate.py --key "your_activation_key" --max-activations 3
```

### 3. 指定配置文件

```bash
python activate.py --config custom_config.json
```

### 命令行参数

- `--key`, `-k`: 激活密钥
- `--db`, `-d`: 数据库文件路径
- `--url`, `-u`: API服务地址
- `--session`, `-s`: 会话ID
- `--config`, `-c`: 配置文件路径
- `--max-activations`, `-m`: 最大激活次数限制

## 权限控制

### 管理员会话
- 可以激活所有用户的符合条件账号
- 日志中会显示每个账号的会话ID信息

### 普通用户会话
- 使用普通的会话ID（不包含管理员关键字）
- 只能激活自己会话ID下的账号
- 提供了数据隔离和安全保护

## 运行逻辑

1. **权限检查**: 根据会话ID判断是管理员还是普通用户
2. **查询账号**: 查找上次激活时间为前一天12点后且激活次数小于3的账号
3. **逐个激活**: 不使用并发，按顺序激活每个账号
4. **暂停等待**: 每个账号激活后暂停10-30秒
5. **重试机制**: 激活失败时自动重试，最多3次
6. **日志记录**: 详细记录激活过程和统计信息

## 日志文件

- `activate.log`: 详细的激活日志
- `activation_stats.log`: 激活统计信息

## 定时运行

### 使用cron（Linux/Mac）

编辑crontab：
```bash
crontab -e
```

添加定时任务（每天早上8点运行）：
```bash
0 8 * * * cd /path/to/your/project && python activate.py
```

### 使用Windows任务计划程序

1. 打开"任务计划程序"
2. 创建基本任务
3. 设置触发器（例如每日）
4. 设置操作：启动程序
   - 程序：`python`
   - 参数：`activate.py`
   - 起始于：脚本所在目录

## 注意事项

1. 确保 `run.py` 服务正在运行
2. 激活密钥需要有效
3. 数据库文件路径正确
4. 网络连接正常
5. 会话ID需要有足够的权限

## 错误排查

1. **无激活密钥**: 检查配置文件或命令行参数
2. **连接失败**: 检查API服务是否运行
3. **数据库错误**: 检查数据库文件路径和权限
4. **权限不足**: 检查会话ID是否有效

## 示例输出

```
2024-01-01 08:00:00 - INFO - ==================================================
2024-01-01 08:00:00 - INFO - 开始PikPak自动激活任务
2024-01-01 08:00:00 - INFO - ==================================================
2024-01-01 08:00:00 - INFO - 激活条件: 上次激活时间为前一天12点后 且 激活次数<3次
2024-01-01 08:00:00 - INFO - 配置信息: 暂停时间=10-30秒, 最大重试=3次
2024-01-01 08:00:00 - INFO - 找到 5 个符合条件的账号（激活次数<3且上次激活时间>前一天12点）
2024-01-01 08:00:00 - INFO - ------------------------------
2024-01-01 08:00:00 - INFO - 处理第 1/5 个账号: user1
2024-01-01 08:00:00 - INFO - 邮箱: user1@example.com
2024-01-01 08:00:00 - INFO - 当前激活次数: 1
2024-01-01 08:00:00 - INFO - 上次激活时间: 2023-12-31 13:30:00
2024-01-01 08:00:00 - INFO - 正在激活账号: user1
2024-01-01 08:00:01 - INFO - ✓ 账号 user1 激活成功 (激活次数: 1 -> 2)
2024-01-01 08:00:01 - INFO - 暂停 15 秒后继续...
2024-01-01 08:00:16 - INFO - ==================================================
2024-01-01 08:00:16 - INFO - 激活任务完成
2024-01-01 08:00:16 - INFO - 总处理账号: 5 个
2024-01-01 08:00:16 - INFO - 激活成功: 5 个
2024-01-01 08:00:16 - INFO - 激活失败: 0 个
2024-01-01 08:00:16 - INFO - 跳过账号: 0 个
2024-01-01 08:00:16 - INFO - ==================================================
``` 